// WokGen — Prisma schema
// PostgreSQL for production (Neon/Vercel Postgres); use sqlite only for local dev.
// To use SQLite locally: set DATABASE_URL="file:./dev.db" in apps/web/.env

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// NextAuth required models
// ---------------------------------------------------------------------------

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  /// Top-up HD credits (never expire, bought via credit packs)
  hdTopUpCredits      Int @default(0)
  /// Monthly HD credits consumed this billing period (reset on period renewal)
  hdMonthlyUsed       Int @default(0)

  /// Whether new generations default to public (community gallery opt-in)
  publicGenerationsDefault Boolean @default(false)

  /// Standard (free-tier) images generated today — atomic daily quota counter
  stdGenToday  Int     @default(0)
  /// UTC date YYYY-MM-DD of the current stdGenToday window (resets at midnight UTC)
  stdGenDate   String?

  accounts           Account[]
  sessions           Session[]
  jobs               Job[]
  projects           Project[]
  subscription       Subscription?
  usagePeriods       UsagePeriod[]
  eralConversations  EralConversation[]
  preference         UserPreference?
  sfxJobs            SfxJob[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------------------------------------------------------
// Billing models
// ---------------------------------------------------------------------------

model Plan {
  id                String  @id   // "free" | "plus" | "pro" | "max"
  name              String
  priceUsdCents     Int           // 0 | 200 | 600 | 1500
  creditsPerMonth   Int           // 0 | 100 | 500 | 2000 (HD Replicate credits)
  /// true = Pollinations unlimited; false = Replicate with monthly HD credits
  isUnlimitedStd    Boolean @default(true)
  stripePriceId     String?       // set after Stripe products are created

  subscriptions Subscription[]
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  planId               String
  /// active | canceled | past_due | trialing
  status               String   @default("active")
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  cancelAtPeriodEnd    Boolean  @default(false)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model UsagePeriod {
  id          String   @id @default(cuid())
  userId      String
  periodStart DateTime
  periodEnd   DateTime
  imagesUsed  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart])
  @@index([userId, periodStart])
}

// ---------------------------------------------------------------------------
// Job — tracks a single generation request through its lifecycle
// ---------------------------------------------------------------------------
model Job {
  id        String   @id @default(cuid())

  /// Optional owner — null for anonymous / self-hosted requests
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Tool that created this job: generate | animate | rotate | inpaint | scene
  tool      String   @default("generate")

  /// Lifecycle: pending → running → succeeded | failed
  status    String   @default("pending")

  /// Provider that ran the job: replicate | fal | together | comfyui
  provider  String   @default("replicate")

  // ---- Inputs ---------------------------------------------------------------
  prompt    String
  negPrompt String?

  /// Width in pixels (canonical export size: 32 | 64 | 128 | 256 | 512)
  width     Int      @default(512)
  height    Int      @default(512)

  /// Deterministic seed; null = random
  seed      Int?

  /// JSON-encoded extra params per tool (e.g. { "style": "rpg", "steps": 20 })
  params    String?

  /// ComfyUI hardware preset used: "lowmem" | "standard" | "hq"
  comfyPreset String?

  // ---- Outputs --------------------------------------------------------------
  /// Primary result URL (single image tools)
  resultUrl   String?

  /// JSON-encoded array of URLs (multi-output tools: rotate, scenes)
  resultUrls  String?

  /// Error message when status = "failed"
  error       String?

  // ---- Metadata -------------------------------------------------------------
  /// Whether this job is visible in the public gallery
  isPublic    Boolean  @default(false)

  /// Optional display title set by the user after generation
  title       String?

  /// JSON-encoded tags list for gallery search
  tags        String?

  /// ISO-8601 timestamp string of external provider prediction (for polling)
  providerJobId String?

  /// Product line that created this job: pixel | business | vector | emoji | uiux
  mode      String   @default("pixel")

  /// Optional project this job belongs to
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // A job can optionally produce a persisted gallery asset
  asset       GalleryAsset?

  @@index([userId])
  @@index([status])
  @@index([tool])
  @@index([mode, isPublic, createdAt])
  @@index([isPublic, createdAt])
  @@index([createdAt])
  @@index([projectId])
}

// ---------------------------------------------------------------------------
// GalleryAsset — a finalised, curated asset promoted from a Job
// ---------------------------------------------------------------------------
model GalleryAsset {
  id        String   @id @default(cuid())

  jobId     String   @unique
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  /// Human-readable title
  title     String?

  /// Primary image URL (hosted by provider CDN or data: URI for local)
  imageUrl  String

  /// Thumbnail URL (same as imageUrl if not separately generated)
  thumbUrl  String?

  /// Canonical export size used for generation
  size      Int      @default(512)

  /// Tool that generated it
  tool      String   @default("generate")

  /// Provider used
  provider  String   @default("replicate")

  /// Original prompt
  prompt    String

  /// JSON-encoded tags
  tags      String?

  /// Rarity label from spec.json rarities (optional, set by user or pipeline)
  rarity    String?

  /// Whether visible in the public gallery
  isPublic  Boolean  @default(true)

  /// SHA-256 of the image bytes (for dedup)
  hash      String?

  /// Product line: pixel | business | vector | emoji | uiux
  mode      String   @default("pixel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isPublic, createdAt])
  @@index([mode, isPublic, createdAt])
  @@index([tool])
  @@index([rarity])
  @@index([hash])
}

// ---------------------------------------------------------------------------
// Project — typed workspace per mode
// Mode is immutable after creation. A job can belong to one project.
// ---------------------------------------------------------------------------
model Project {
  id          String   @id @default(cuid())
  userId      String

  /// Product line: pixel | business | vector | emoji | uiux (immutable after creation)
  mode        String

  name        String
  description String?

  /// JSON-encoded mode-specific project settings
  settings    String?

  isArchived  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs Job[]

  @@index([userId, mode])
  @@index([userId, isArchived])
}

// ---------------------------------------------------------------------------
// Eral — AI Companion models
// ---------------------------------------------------------------------------

model EralConversation {
  id        String        @id @default(cuid())
  userId    String?
  title     String?
  mode      String?       // context: which WokGen mode it was opened in
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  EralMessage[]
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model EralMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String           // 'user' | 'assistant' | 'system'
  content        String           @db.Text
  modelUsed      String?
  durationMs     Int?
  createdAt      DateTime         @default(now())
  conversation   EralConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

// ---------------------------------------------------------------------------
// Eral User Memory — preferences, stats, favorites
// ---------------------------------------------------------------------------

model UserPreference {
  id        String   @id @default(cuid())
  userId    String

  // Per-mode style preferences (JSON: { stylePreset, size, tool, useHD, etc. })
  pixelPrefs    String?  @db.Text
  businessPrefs String?  @db.Text
  vectorPrefs   String?  @db.Text
  emojiPrefs    String?  @db.Text
  uiuxPrefs     String?  @db.Text
  voicePrefs    String?  @db.Text
  textPrefs     String?  @db.Text

  // Eral preferences
  eralDefaultModel    String?  @default("eral-7c")
  eralPersonality     String?  @default("balanced")  // balanced | technical | creative | concise

  // Favorite prompts (JSON array)
  favoritePrompts String?  @db.Text

  // Usage stats (JSON: { totalGenerations, successRate, lastActive })
  stats           String?  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
}

/// Guest (unauthenticated) standard generation usage by IP per day.
/// Used as DB fallback when Redis is unavailable.
model GuestUsage {
  ip    String
  date  String  // YYYY-MM-DD UTC
  count Int     @default(0)

  @@id([ip, date])
  @@index([date])
}

/// Per-key sliding-window rate limit counters.
/// Used as fallback when Upstash Redis is not configured.
model RateLimit {
  key      String @id
  count    Int
  reset_at BigInt // Unix ms timestamp when the window resets
}

// ---------------------------------------------------------------------------
// SfxJob — tracks a sound effect generation request
// ---------------------------------------------------------------------------
model SfxJob {
  id              String   @id @default(cuid())
  userId          String?
  prompt          String
  durationSeconds Float
  audioUrl        String?
  provider        String   @default("elevenlabs")
  status          String   @default("pending")
  error           String?
  createdAt       DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}
