// WokGen — Prisma schema
// PostgreSQL for production (Neon/Vercel Postgres); use sqlite only for local dev.
// To use SQLite locally: set DATABASE_URL="file:./dev.db" in apps/web/.env

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------------------------------------------------------------------------
// NextAuth required models
// ---------------------------------------------------------------------------

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  /// Top-up HD credits (never expire, bought via credit packs)
  hdTopUpCredits Int @default(0)
  /// Monthly HD credits consumed this billing period (reset on period renewal)
  hdMonthlyUsed  Int @default(0)

  /// Whether new generations default to public (community gallery opt-in)
  publicGenerationsDefault Boolean @default(false)

  /// Admin flag — grants access to admin panel and APIs
  isAdmin Boolean @default(false)

  /// Standard (free-tier) images generated today — atomic daily quota counter
  stdGenToday Int     @default(0)
  /// UTC date YYYY-MM-DD of the current stdGenToday window (resets at midnight UTC)
  stdGenDate  String?

  accounts          Account[]
  sessions          Session[]
  jobs              Job[]
  projects          Project[]
  subscription      Subscription?
  usagePeriods      UsagePeriod[]
  eralConversations EralConversation[]
  preference        UserPreference?
  sfxJobs           SfxJob[]
  automations       Automation[]
  apiKeys           ApiKey[]
  onboarding        OnboardingState?
  brandKits         BrandKit[]
  projectMembers    ProjectMember[]
  assetComments     AssetComment[]
  activityEvents    ActivityEvent[]
  notifications     Notification[]
  webhooks          Webhook[]
  referralsGiven    Referral[]         @relation("ReferralsGiven")
  referralsReceived Referral[]         @relation("ReferralsReceived")
  eralNotes         EralNote[]
  generationPresets GenerationPreset[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------------------------------------------------------
// Billing models
// ---------------------------------------------------------------------------

model Plan {
  id              String  @id // "free" | "plus" | "pro" | "max"
  name            String
  priceUsdCents   Int // 0 | 200 | 600 | 1500
  creditsPerMonth Int // 0 | 100 | 500 | 2000 (HD Replicate credits)
  /// true = Pollinations unlimited; false = Replicate with monthly HD credits
  isUnlimitedStd  Boolean @default(true)
  stripePriceId   String? // set after Stripe products are created

  subscriptions Subscription[]
}

model Subscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  planId               String
  /// active | canceled | past_due | trialing
  status               String   @default("active")
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model UsagePeriod {
  id          String   @id @default(cuid())
  userId      String
  periodStart DateTime
  periodEnd   DateTime
  imagesUsed  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart])
  @@index([userId, periodStart])
}

// ---------------------------------------------------------------------------
// Job — tracks a single generation request through its lifecycle
// ---------------------------------------------------------------------------
model Job {
  id String @id @default(cuid())

  /// Optional owner — null for anonymous / self-hosted requests
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  /// Tool that created this job: generate | animate | rotate | inpaint | scene
  tool String @default("generate")

  /// Lifecycle: pending → running → succeeded | failed
  status String @default("pending")

  /// Provider that ran the job: replicate | fal | together | comfyui
  provider String @default("replicate")

  // ---- Inputs ---------------------------------------------------------------
  prompt    String
  negPrompt String?

  /// Width in pixels (canonical export size: 32 | 64 | 128 | 256 | 512)
  width  Int @default(512)
  height Int @default(512)

  /// Deterministic seed; null = random
  seed Int?

  /// JSON-encoded extra params per tool (e.g. { "style": "rpg", "steps": 20 })
  params String?

  /// ComfyUI hardware preset used: "lowmem" | "standard" | "hq"
  comfyPreset String?

  // ---- Outputs --------------------------------------------------------------
  /// Primary result URL (single image tools)
  resultUrl String?

  /// JSON-encoded array of URLs (multi-output tools: rotate, scenes)
  resultUrls String?

  /// Error message when status = "failed"
  error String?

  // ---- Metadata -------------------------------------------------------------
  /// Whether this job is visible in the public gallery
  isPublic Boolean @default(false)

  /// Optional display title set by the user after generation
  title String?

  /// JSON-encoded tags list for gallery search
  tags String?

  /// ISO-8601 timestamp string of external provider prediction (for polling)
  providerJobId String?

  /// Product line that created this job: pixel | business | vector | uiux
  mode String @default("pixel")

  /// Optional project this job belongs to
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  /// Extracted dominant palette (JSON: [{hex, name, ratio}])
  paletteJson String? @db.Text

  /// User thumbs-up (1) or thumbs-down (-1) rating on this result
  userRating Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A job can optionally produce a persisted gallery asset
  asset GalleryAsset?

  // Asset relationships where this job is the source or target
  assetRelFrom AssetRelationship[] @relation("RelFrom")
  assetRelTo   AssetRelationship[] @relation("RelTo")
  assetTags    AssetTag[]
  comments     AssetComment[]

  @@index([userId])
  @@index([status])
  @@index([tool])
  @@index([mode, isPublic, createdAt])
  @@index([isPublic, createdAt])
  @@index([createdAt])
  @@index([projectId])
  @@index([projectId, status])
  @@index([userId, createdAt])
  @@index([userId, mode, status])
  @@index([status, createdAt])
}

// ---------------------------------------------------------------------------
// GalleryAsset — a finalised, curated asset promoted from a Job
// ---------------------------------------------------------------------------
model GalleryAsset {
  id String @id @default(cuid())

  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  /// Human-readable title
  title String?

  /// Primary image URL (hosted by provider CDN or data: URI for local)
  imageUrl String

  /// Thumbnail URL (same as imageUrl if not separately generated)
  thumbUrl String?

  /// Canonical export size used for generation
  size Int @default(512)

  /// Tool that generated it
  tool String @default("generate")

  /// Provider used
  provider String @default("replicate")

  /// Original prompt
  prompt String

  /// JSON-encoded tags
  tags String?

  /// Rarity label from spec.json rarities (optional, set by user or pipeline)
  rarity String?

  /// Whether visible in the public gallery
  isPublic Boolean @default(true)

  /// SHA-256 of the image bytes (for dedup)
  hash String?

  /// Product line: pixel | business | vector | uiux
  mode String @default("pixel")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isPublic, createdAt])
  @@index([mode, isPublic, createdAt])
  @@index([tool])
  @@index([rarity])
  @@index([hash])
}

// ---------------------------------------------------------------------------
// Project — typed workspace per mode
// Mode is immutable after creation. A job can belong to one project.
// ---------------------------------------------------------------------------
model Project {
  id     String @id @default(cuid())
  userId String

  /// Product line: pixel | business | vector | uiux (immutable after creation)
  mode String

  name        String
  description String?

  /// JSON-encoded mode-specific project settings
  settings String?

  isArchived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs          Job[]
  brief         ProjectBrief?
  brandKit      BrandKit[]
  members       ProjectMember[]
  relationships AssetRelationship[]
  activity      ActivityEvent[]

  @@index([userId, mode])
  @@index([userId, isArchived])
  @@index([userId, updatedAt])
}

// ---------------------------------------------------------------------------
// Eral — AI Companion models
// ---------------------------------------------------------------------------

model EralConversation {
  id        String        @id @default(cuid())
  userId    String?
  title     String?
  mode      String? // context: which WokGen mode it was opened in
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  EralMessage[]
  user      User?         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model EralMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String // 'user' | 'assistant' | 'system'
  content        String           @db.Text
  modelUsed      String?
  durationMs     Int?
  createdAt      DateTime         @default(now())
  conversation   EralConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

// ---------------------------------------------------------------------------
// Eral User Memory — preferences, stats, favorites
// ---------------------------------------------------------------------------

model UserPreference {
  id     String @id @default(cuid())
  userId String

  // Per-mode style preferences (JSON: { stylePreset, size, tool, useHD, etc. })
  pixelPrefs    String? @db.Text
  businessPrefs String? @db.Text
  vectorPrefs   String? @db.Text
  uiuxPrefs     String? @db.Text
  voicePrefs    String? @db.Text
  textPrefs     String? @db.Text

  // Eral preferences
  eralDefaultModel String? @default("eral-7c")
  eralPersonality  String? @default("balanced") // balanced | technical | creative | concise
  eralMemory       String? @db.Text // JSON array of remembered facts [{ key, value, savedAt }]
  eralContext      String? @db.Text // JSON: { projectType, mainTool, stylePreference } from intro questions

  // Favorite prompts (JSON array)
  favoritePrompts String? @db.Text

  // Notification settings (booleans as JSON or individual flags)
  notifyEmailJobDone Boolean @default(true)
  notifyEmailComment Boolean @default(true)
  notifyEmailDigest  Boolean @default(false)
  notifyInAppQuota   Boolean @default(true)
  notifyInAppLevelUp Boolean @default(true)
  // Admin: notification routing channel — 'email' | 'webhook' | 'both' | 'none'
  notifyAdminChannel String? @default("email")
  notifyWebhookUrl   String? @db.Text

  // Usage stats (JSON: { totalGenerations, successRate, lastActive })
  stats String? @db.Text

  onboardingStep     Int     @default(0)
  onboardingComplete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([userId])
}

/// Guest (unauthenticated) standard generation usage by IP per day.
/// Used as DB fallback when Redis is unavailable.
model GuestUsage {
  ip    String
  date  String // YYYY-MM-DD UTC
  count Int    @default(0)

  @@id([ip, date])
  @@index([date])
}

/// Per-key sliding-window rate limit counters.
/// Used as fallback when Upstash Redis is not configured.
model RateLimit {
  key      String @id
  count    Int
  reset_at BigInt // Unix ms timestamp when the window resets
}

// ---------------------------------------------------------------------------
// SfxJob — tracks a sound effect generation request
// ---------------------------------------------------------------------------
model SfxJob {
  id              String   @id @default(cuid())
  userId          String?
  prompt          String
  durationSeconds Float
  audioUrl        String?
  provider        String   @default("elevenlabs")
  createdAt       DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
}

// ---------------------------------------------------------------------------
// Depth features — asset relationships, project briefs, brand kits, team
// ---------------------------------------------------------------------------

/// Links two jobs together within a project (e.g. character → matching enemy)
model AssetRelationship {
  id        String   @id @default(cuid())
  projectId String
  fromJobId String
  toJobId   String
  /// variation | animation_of | enemy_of | tileset_for | same_palette | brand_use
  type      String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  fromJob Job     @relation("RelFrom", fields: [fromJobId], references: [id], onDelete: Cascade)
  toJob   Job     @relation("RelTo", fields: [toJobId], references: [id], onDelete: Cascade)

  @@unique([fromJobId, toJobId, type])
  @@index([projectId])
}

/// Project-level creative brief — drives Eral asset director suggestions
model ProjectBrief {
  id        String @id @default(cuid())
  projectId String @unique

  // Free-text project brief for Eral context (Cycle 16)
  content     String? @db.Text
  projectType String? // platformer | rpg | brand | product | content | app | puzzle | other

  // Game project fields
  genre       String? // dungeon_crawler | platformer | top_down_rpg | city_builder
  artStyle    String? // nes_16color | snes_32color | gb_monochrome | modern_pixel
  paletteJson String? @db.Text // JSON: [{hex, name}]
  moodBoard   String? @db.Text // JSON: [imageUrl]

  // Brand project fields
  brandName  String?
  industry   String?
  colorHex   String? // primary brand color
  styleGuide String? @db.Text

  // Pinned style snapshot (JSON: full preset config)
  pinnedStyle String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

/// Persistent brand kit — palette, typography direction, style guide
model BrandKit {
  id        String  @id @default(cuid())
  userId    String
  projectId String?

  name        String
  /// JSON: [{hex, name, role}]
  paletteJson String  @db.Text
  /// JSON: {primary, secondary, scale}
  typography  String? @db.Text
  styleGuide  String? @db.Text
  industry    String?
  mood        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
}

/// Team membership for a project
model ProjectMember {
  id           String   @id @default(cuid())
  projectId    String
  userId       String? // nullable for pending invites
  /// owner | editor | viewer
  role         String   @default("viewer")
  invitedBy    String?
  inviteToken  String?  @unique // token for accepting pending invites
  inviteStatus String?  @default("pending") // pending | accepted | declined
  createdAt    DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

/// Freeform tags on individual jobs (for gallery search and project organization)
model AssetTag {
  id     String  @id @default(cuid())
  jobId  String
  tag    String
  userId String?

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, tag])
  @@index([jobId])
  @@index([tag])
}

/// Activity feed event for a project
model ActivityEvent {
  id        String  @id @default(cuid())
  projectId String
  userId    String?
  /// generate | comment | like | export | member_join | brief_update | batch
  type      String
  /// Human-readable summary: "Generated 'dragon sprite' with pixel/generate"
  message   String
  /// Optional reference: jobId, commentId, etc.
  refId     String?

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId, createdAt])
  @@index([userId, createdAt])
}

/// Comment on a generated asset
model AssetComment {
  id        String   @id @default(cuid())
  jobId     String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
}

/// Scheduled automation — send a message or trigger an action on a cron schedule
model Automation {
  id     String @id @default(cuid())
  userId String

  name    String
  enabled Boolean @default(true)

  /// cron expression: "0 9 * * 1" = every Monday 9am UTC
  schedule String

  /// Target type: 'email' | 'webhook' | 'in_app'
  targetType String @default("email")

  /// Webhook URL or email address depending on targetType
  targetValue String? @db.Text

  /// Template message (supports {{date}}, {{user_name}}, {{quota_used}})
  messageTemplate String @db.Text

  /// Last time this automation ran
  lastRunAt DateTime?

  /// Last run result: 'ok' | 'error'
  lastRunStatus String?
  lastRunError  String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([enabled, schedule])
}

model ApiKey {
  id           String    @id @default(cuid())
  userId       String
  name         String
  /// SHA-256 hex hash of the raw key — stored, never the key itself
  keyHash      String    @unique
  /// First 8 chars of key for display, e.g. "wk_live_a1b2c3d4"
  keyPrefix    String
  /// Comma-separated scopes: "generate,read" etc.
  scopes       String    @default("generate,read")
  lastUsedAt   DateTime?
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  requestCount Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyHash])
}

model OnboardingState {
  id          String    @id @default(cuid())
  userId      String    @unique
  step        Int       @default(0)
  useCase     String?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------------------------------------
// Notification — in-app and email notification events (Cycle 27)
// ---------------------------------------------------------------------------
model Notification {
  id        String   @id @default(cuid())
  userId    String
  /// generation_complete | quota_warning | level_up | batch_complete |
  /// director_plan_complete | project_invite | automation_ran | team_joined
  type      String
  title     String
  body      String   @db.Text
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
}

// ---------------------------------------------------------------------------
// Webhook — user-defined outbound webhooks (Cycle 29)
// ---------------------------------------------------------------------------
model Webhook {
  id              String    @id @default(cuid())
  userId          String
  url             String
  /// Comma-separated event names, e.g. "generation.complete,job.failed"
  events          String
  secret          String
  active          Boolean   @default(true)
  lastStatus      String?
  lastTriggeredAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ---------------------------------------------------------------------------
// Referral — user referral tracking (Cycle 31)
// ---------------------------------------------------------------------------
model Referral {
  id             String   @id @default(cuid())
  referrerId     String
  referredUserId String   @unique
  code           String
  /// pending | credited
  status         String   @default("pending")
  creditsAwarded Int      @default(0)
  createdAt      DateTime @default(now())

  referrer User @relation("ReferralsGiven", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("ReferralsReceived", fields: [referredUserId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([code])
}

// ---------------------------------------------------------------------------
// EralNote — site-wide persistent notepad for Eral 7c companion
// ---------------------------------------------------------------------------
model EralNote {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("Untitled")
  content   String   @db.Text
  pinned    Boolean  @default(false)
  /// accent color token: "default" | "purple" | "blue" | "green" | "amber" | "red"
  color     String   @default("default")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags EralNoteTag[]

  @@index([userId, pinned])
  @@index([userId, updatedAt])
}

model EralNoteTag {
  id     String @id @default(cuid())
  noteId String
  tag    String

  note EralNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, tag])
  @@index([tag])
}

// ---------------------------------------------------------------------------
// GenerationPreset — saved parameter sets for quick generation
// ---------------------------------------------------------------------------
model GenerationPreset {
  id         String   @id @default(cuid())
  userId     String
  name       String
  mode       String
  prompt     String   @db.Text
  params     Json?
  brandKitId String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
